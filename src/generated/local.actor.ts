// DO NOT EDIT.
// Generated by actr-ts-codegen.

import { ContextBridge, RpcEnvelopeBridge } from '@actor-rtc/actr';
import type { PayloadType } from '@actor-rtc/actr';
import { ATTACH_ROUTE_KEY, PROMPT_ROUTE_KEY } from './ask.client.js';
import { Ask_AssistantReply, Ask_AttachRequest, Ask_AttachResponse, Ask_UsrPromptRequest } from './ask.pb.js';

export interface LocalHandler {
  prompt(request: Ask_UsrPromptRequest, ctx: ContextBridge): Promise<Ask_AssistantReply>;
  attach(request: Ask_AttachRequest, ctx: ContextBridge): Promise<Ask_AttachResponse>;
}

const RPC_TIMEOUT_MS = 15000;
const RPC_PAYLOAD_TYPE: PayloadType = 0;

const ROUTES = [
  {
    routeKey: PROMPT_ROUTE_KEY,
    targetType: {"manufacturer":"askaway1","name":"AskService"},
  },
  {
    routeKey: ATTACH_ROUTE_KEY,
    targetType: {"manufacturer":"askaway1","name":"AskService"},
  },
];

export async function dispatch(
  handler: LocalHandler,
  ctx: ContextBridge,
  envelope: RpcEnvelopeBridge
): Promise<Buffer> {
  const match = ROUTES.find((route) => route.routeKey === envelope.routeKey);
  if (!match) {
    throw new Error(`Unknown route: ${envelope.routeKey}`);
  }

  const targetId = await ctx.discover(match.targetType);
  return await ctx.callRaw(
    targetId,
    envelope.routeKey,
    RPC_PAYLOAD_TYPE,
    envelope.payload,
    RPC_TIMEOUT_MS
  );
}